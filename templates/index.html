<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1v1 Lucky 777 Battle</title>
    <style>
        body { background: #0f001a; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; }
        #auth, #game { background: #1a1a1a; border: 2px solid gold; border-radius: 15px; padding: 20px; max-width: 800px; margin: auto; }
        .reels { display: flex; justify-content: center; gap: 10px; margin: 20px; }
        .reel { background: white; color: black; font-size: 50px; width: 80px; height: 100px; line-height: 100px; border-radius: 10px; }
        button { background: linear-gradient(#bf953f, #fcf6ba); border: none; padding: 15px 30px; font-weight: bold; cursor: pointer; border-radius: 5px; margin: 10px; }
        button:disabled { filter: grayscale(1); cursor: not-allowed; }
        table { width: 100%; margin-top: 20px; border-collapse: collapse; background: #222; }
        th, td { border: 1px solid #444; padding: 10px; }
        .my-turn { border: 3px solid #0f0; box-shadow: 0 0 15px #0f0; }
        .leaderboard { margin-top: 20px; font-size: 14px; color: #aaa; }
    </style>
</head>
<body>

<div id="auth">
    <h2>üé∞ 1v1 SLOT BATTLE</h2>
    <input id="u" placeholder="Username" style="padding:10px; width:80%"><br><br>
    <input id="p" type="password" placeholder="Password" style="padding:10px; width:80%"><br><br>
    <button onclick="auth('login')">LOGIN</button>
    <button onclick="auth('signup')">SIGN UP</button>
</div>

<div id="game" style="display:none">
    <div style="display:flex; justify-content: space-between;">
        <span id="name-tag"></span>
        <span id="bal-tag" style="color:gold"></span>
        <button onclick="logout()" style="padding:5px; background:red; color:white">Logout</button>
    </div>

    <div class="reels">
        <div class="reel" id="r1">?</div>
        <div class="reel" id="r2">?</div>
        <div class="reel" id="r3">?</div>
    </div>

    <div id="match-controls">
        <button id="joinBtn" onclick="joinMatch()">‚öîÔ∏è FIND 1v1 MATCH</button>
        <button id="spinBtn" onclick="spin()" style="display:none; font-size:20px">üé∞ SPIN NOW!</button>
    </div>

    <h2 id="status-msg">Welcome! Join a battle.</h2>

    <div id="battle-stats" style="display:none">
        <div style="display:flex; justify-content: space-around; font-size: 20px; font-weight: bold;">
            <div style="color:lime">ME: <span id="my-score">0</span></div>
            <div style="color:orange">OPP (<span id="opp-name"></span>): <span id="opp-score">0</span></div>
        </div>

        <table>
            <thead><tr><th>Player</th><th>Spin</th><th>Points</th></tr></thead>
            <tbody id="history-body"></tbody>
        </table>
    </div>

    <div class="leaderboard" id="lead"></div>
</div>

<script>
    let matchId = null;
    let poll = null;

    async function auth(type) {
        const username = document.getElementById('u').value;
        const password = document.getElementById('p').value;
        const res = await fetch(`/api/auth/${type}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        const data = await res.json();
        if (data.user) location.reload(); else alert(data.error);
    }

    window.onload = async () => {
        const res = await fetch('/api/auth/check');
        const data = await res.json();
        if (data.logged_in) {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            document.getElementById('name-tag').innerText = "Player: " + data.user.username;
            document.getElementById('bal-tag').innerText = "Balance: " + data.user.balance;
            loadLead();
        }
    };

    async function joinMatch() {
        document.getElementById('status-msg').innerText = "Searching for opponent...";
        const res = await fetch('/api/match/join', {method: 'POST'});
        const data = await res.json();
        if (data.match_id) startBattle(data.match_id);
        else poll = setInterval(async () => {
            const r = await fetch('/api/match/join', {method: 'POST'});
            const d = await r.json();
            if (d.match_id) { clearInterval(poll); startBattle(d.match_id); }
        }, 2000);
    }

    function startBattle(id) {
        matchId = id;
        document.getElementById('joinBtn').style.display = 'none';
        document.getElementById('spinBtn').style.display = 'inline-block';
        document.getElementById('battle-stats').style.display = 'block';
        
        poll = setInterval(async () => {
            const res = await fetch(`/api/match/${matchId}/status`);
            const data = await res.json();
            
            document.getElementById('my-score').innerText = data.my_score;
            document.getElementById('opp-score').innerText = data.opp_score;
            document.getElementById('opp-name').innerText = data.opp_name;
            
            // Update History Table
            document.getElementById('history-body').innerHTML = data.history.map(h => 
                `<tr><td>${h.player}</td><td>${h.reels.join('')}</td><td>+${h.points}</td></tr>`
            ).reverse().join('');

            if (data.status === 'finished') {
                document.getElementById('status-msg').innerText = "üèÅ WINNER: " + data.winner;
                document.getElementById('spinBtn').disabled = true;
                clearInterval(poll);
                setTimeout(() => location.reload(), 5000);
            } else {
                document.getElementById('status-msg').innerText = data.is_my_turn ? "üî• YOUR TURN!" : "‚åõ OPPONENT IS SPINNING...";
                document.getElementById('spinBtn').disabled = !data.is_my_turn;
                if(data.is_my_turn) document.getElementById('game').classList.add('my-turn');
                else document.getElementById('game').classList.remove('my-turn');
            }
        }, 1500);
    }

    async function spin() {
        const res = await fetch(`/api/match/${matchId}/spin`, {method: 'POST'});
        const data = await res.json();
        document.getElementById('r1').innerText = data.reels[0];
        document.getElementById('r2').innerText = data.reels[1];
        document.getElementById('r3').innerText = data.reels[2];
    }

    async function loadLead() {
        const res = await fetch('/api/leaderboard');
        const data = await res.json();
        document.getElementById('lead').innerHTML = "<b>Global Ranking:</b> " + data.map(i => `${i.u}(${i.b})`).join(' | ');
    }

    function logout() { fetch('/api/auth/logout', {method: 'POST'}).then(() => location.reload()); }
</script>
</body>
</html>
