<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lucky 777 Multiplayer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {--gold: linear-gradient(to bottom, #bf953f, #fcf6ba, #b38728);}
        body { margin: 0; background: #1a0033; color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #auth, #game { background: rgba(0,0,0,0.9); padding: 30px; border-radius: 15px; border: 2px solid gold; width: 90%; max-width: 800px; }
        .reel-container { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
        .reel { width: 80px; height: 100px; background: white; color: black; font-size: 50px; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
        button { background: var(--gold); border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 5px; }
        button:disabled { background: #555; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; }
        .my-turn { border: 2px solid #0f0; box-shadow: 0 0 10px #0f0; }
    </style>
</head>
<body>

<div id="auth">
    <h2>üé∞ LUCKY 777 LOGIN</h2>
    <input id="u" placeholder="Username" style="padding:10px; width:90%"><br><br>
    <input id="p" type="password" placeholder="Password" style="padding:10px; width:90%"><br><br>
    <button onclick="auth('login')">LOGIN</button>
    <button onclick="auth('signup')" style="background:none; color:gold; border:1px solid gold">SIGN UP</button>
    <p id="auth-err" style="color:red"></p>
</div>

<div id="game" style="display:none">
    <div style="display:flex; justify-content:space-between">
        <h3 id="user-display">User: -</h3>
        <h3 id="balance-display" style="color:gold">Balance: 0</h3>
        <button onclick="logout()" style="background:red; color:white">Logout</button>
    </div>

    <div class="reel-container">
        <div class="reel" id="r1">?</div>
        <div class="reel" id="r2">?</div>
        <div class="reel" id="r3">?</div>
    </div>

    <div style="text-align:center">
        <button id="spinBtn" onclick="singleSpin()" style="font-size:20px; width:200px">üé∞ SPIN (10 pts)</button>
        <button id="joinBtn" onclick="joinMatch()" style="font-size:20px; background:blue; color:white">‚öîÔ∏è 1v1 BATTLE</button>
    </div>

    <div class="grid">
        <div class="box">
            <h4>üèÜ LEADERBOARD</h4>
            <div id="leaderboard"></div>
        </div>
        <div class="box" id="match-box" style="display:none">
            <h4 id="match-status">Finding Opponent...</h4>
            <div id="battle-area">
                <p>Opponent: <span id="opp-name">-</span></p>
                <p>My Score: <span id="my-score">0</span> | Opp Score: <span id="opp-score">0</span></p>
            </div>
        </div>
    </div>
</div>

<script>
    let balance = 0;
    let matchId = null;
    let pollInterval = null;

    // IMPORTANT: Check session on refresh
    window.onload = async function() {
        const res = await fetch('/api/auth/check');
        const data = await res.json();
        if (data.logged_in) {
            showGame(data.user);
        }
    };

    async function auth(type) {
        const username = document.getElementById('u').value;
        const password = document.getElementById('p').value;
        const res = await fetch(`/api/auth/${type}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        const data = await res.json();
        if (data.error) document.getElementById('auth-err').innerText = data.error;
        else showGame(data.user);
    }

    function showGame(user) {
        document.getElementById('auth').style.display = 'none';
        document.getElementById('game').style.display = 'block';
        document.getElementById('user-display').innerText = user.username;
        balance = user.balance;
        updateUI();
        loadLeaderboard();
        setInterval(loadLeaderboard, 10000);
    }

    function updateUI() {
        document.getElementById('balance-display').innerText = `Balance: ${balance}`;
    }

    async function loadLeaderboard() {
        const res = await fetch('/api/leaderboard');
        const data = await res.json();
        document.getElementById('leaderboard').innerHTML = data.map(u => 
            `<div>${u.username}: ${u.balance}</div>`).join('');
    }

    async function singleSpin() {
        if (balance < 10) return alert("Low balance!");
        const res = await fetch('/api/game/spin', {method: 'POST'});
        const data = await res.json();
        updateReels(data.reels);
        balance = data.new_balance;
        updateUI();
    }

    function updateReels(reels) {
        document.getElementById('r1').innerText = reels[0];
        document.getElementById('r2').innerText = reels[1];
        document.getElementById('r3').innerText = reels[2];
    }

    async function joinMatch() {
        document.getElementById('match-box').style.display = 'block';
        const res = await fetch('/api/match/join', {method: 'POST'});
        const data = await res.json();
        if (data.match_id) startPolling(data.match_id);
        else if (data.status === 'waiting') {
            pollInterval = setInterval(async () => {
                const check = await fetch('/api/match/join', {method: 'POST'});
                const d = await check.json();
                if (d.match_id) { clearInterval(pollInterval); startPolling(d.match_id); }
            }, 3000);
        }
    }

    function startPolling(id) {
        matchId = id;
        pollInterval = setInterval(async () => {
            const res = await fetch(`/api/match/${matchId}/status`);
            const data = await res.json();
            
            document.getElementById('match-status').innerText = data.is_my_turn ? "YOUR TURN!" : "Opponent Turn...";
            document.getElementById('opp-name').innerText = data.opp_username;
            document.getElementById('my-score').innerText = data.my_total;
            document.getElementById('opp-score').innerText = data.opp_total;
            
            document.getElementById('spinBtn').onclick = data.is_my_turn ? battleSpin : singleSpin;
            if (data.is_my_turn) document.getElementById('match-box').classList.add('my-turn');
            else document.getElementById('match-box').classList.remove('my-turn');

        }, 2000);
    }

    async function battleSpin() {
        const res = await fetch(`/api/match/${matchId}/spin`, {method: 'POST'});
        const data = await res.json();
        updateReels(data.reels);
    }

    function logout() {
        fetch('/api/auth/logout', {method: 'POST'}).then(() => location.reload());
    }
</script>
</body>
</html>
